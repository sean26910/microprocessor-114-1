//
// GPIO_7seg : counting from 0 to 9999 and display on 7-segment LEDs
//
#include <stdio.h>
#include <stdlib.h>
#include "NUC100Series.h"
#include "MCU_init.h"
#include "SYS_init.h"
#include "LCD.h"
#include "Scankey.h"
#include "Seven_Segment.h"
#include "Draw2D.h"
#include <string.h>
#include "math.h"

volatile uint32_t cnt_500ms = 0;
volatile uint8_t rx_flag=0,numindex=0,player[4],myinput[4],ans[4],keyflag = 0;
volatile char rx_buf[32];
volatile uint8_t answermap[9]={0};
char tx_buf[32];

void Init_Timer1(void)
{
	TIMER_Open(TIMER1, TMR1_OPERATING_MODE, 200);
  TIMER_EnableInt(TIMER1);
  NVIC_EnableIRQ(TMR1_IRQn);
  TIMER_Start(TIMER1);
}

void show_7seg(int i,int score);

void TMR1_IRQHandler(void)
{	
	static int num = 3;
	uint32_t number=0;
	
	number+=(ans[0]*1000 + ans[1]*100 + ans[2]*10 + ans[3]);
	show_7seg(num,number);
	num--;
	if(num<0)
		num = 3;
	cnt_500ms++;
	
  TIMER_ClearIntFlag(TIMER1); // Clear Timer1 time-out interrupt flag
}

void Init_GPIO(void)
{
	GPIO_SetMode(PA, BIT12, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT13, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT14, GPIO_MODE_OUTPUT);
	PA12=1;
	PA13=1;
	PA14=1;
	
	GPIO_SetMode(PC, BIT12, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT13, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT14, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT15, GPIO_MODE_OUTPUT);
	PC12=1;PC13=1;PC14=1;PC15=1;
}

void Init_UART1(void)
{
	UART_Open(UART1,115200);
	UART_ENABLE_INT(UART1,UART_IER_RDA_IEN_Msk);
	NVIC_EnableIRQ(UART1_IRQn);
}

void UART1_IRQHandler(void)
{
		uint8_t c;
    uint32_t u32IntSts = UART1->ISR;
		if(u32IntSts & UART_IS_RX_READY(UART1))
		{
			while(!UART_GET_RX_EMPTY(UART1))
			{
				c = UART_READ(UART1);
				if(rx_flag)
					continue;
				
				
				if(c!='\n')
					rx_buf[numindex++] = c;
				else
				{
					numindex = 0;
					rx_flag = 1;
				}
			}
		}
}

void serial_print(char *buffer)
{
		UART_Write(UART1,(uint8_t*)buffer,(uint32_t)strlen(buffer));
}

int key_release(void)
{
		static int prekey = 0;
		int presentkey = 0,result = 0;
		presentkey = ScanKey();
		CLK_SysTickDelay(1000);
		if(prekey!=0 && presentkey==0)
			result = prekey;
		else
			result = 0;
		prekey = presentkey;
		return result;
}

void check(uint32_t *a,uint32_t *b)
{
		int i,j;
		*a=0;*b=0;
		for(i=0;i<4;i++)
		{
			for(j=0;j<4;j++)
			{
				if(ans[i]==player[j])
				{
					if(i==j)
						*a+=1;
					else
						*b+=1;
				}
			}
		}
}

void EINT1_IRQHandler(void)
{
    GPIO_CLR_INT_FLAG(PB, BIT15);	// Clear GPIO interrupt flag
	  keyflag = 1;
}

void Init_EXTINT(void)
{
	  // Configure EINT1 pin and enable interrupt by rising and falling edge trigger
    GPIO_SetMode(PB, BIT15, GPIO_MODE_INPUT);
    GPIO_EnableEINT1(PB, 15, GPIO_INT_RISING); // RISING, FALLING, BOTH_EDGE, HIGH, LOW
    NVIC_EnableIRQ(EINT1_IRQn);

    // Enable interrupt de-bounce function and select de-bounce sampling cycle time
    GPIO_SET_DEBOUNCE_TIME(GPIO_DBCLKSRC_LIRC, GPIO_DBCLKSEL_64);
    GPIO_ENABLE_DEBOUNCE(PB, BIT15);
}

void randomNumber(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		do
		{
			ans[i] = rand()%9+1;
		}while(answermap[ans[i]]==1);
		answermap[ans[i]] = 1;
	}
}

int32_t main()
{		
		int i,key;
		uint32_t countera,counterb,size=0,input=0,line=0,counter=0;
		char bufshow[4][20];
    Init_GPIO();
		SYS_Init();
		init_LCD();
		clear_LCD();
		OpenKeyPad();
		Init_Timer1();
		Init_UART1();
		Init_EXTINT();              
		
    while(1)
		{
			srand(counter++);
			if(keyflag)
			{
				for(i=0;i<9;i++)
					answermap[i]=0;
				randomNumber();
				keyflag = 0;
			}
			
			key = key_release();
			if(key!=0 && size<4)
			{
				input = (10*input + key);
				myinput[0] = input/1000;
				myinput[1] = (input/100)%10;
				myinput[2] = (input/10)%10;
				myinput[3] = input%10;
				size++;
			}
			
			if(size>=4)
			{
				sprintf(tx_buf,"%c%c%c%c\n",myinput[0]+'0',myinput[1]+'0',myinput[2]+'0',myinput[3]+'0');
				serial_print(tx_buf);
				size = 0;
				input = 0;
			}
			
			if(rx_flag)
			{
				//compare
				for(i=0;i<4;i++)
					player[i] = rx_buf[i]-'0';
				check(&countera,&counterb);
				
				if(line<4)
				{
					sprintf(bufshow[line],"%d%d%d%d %dA%dB ",player[0],player[1],player[2],player[3],countera,counterb);
					print_Line(line,bufshow[line]);
					line++;
				}
				else
				{
					strcpy(bufshow[0],bufshow[1]);
					strcpy(bufshow[1],bufshow[2]);
					strcpy(bufshow[2],bufshow[3]);
					sprintf(bufshow[3],"%d%d%d%d %dA%dB ",player[0],player[1],player[2],player[3],countera,counterb);
					clear_LCD();
					for(i=0;i<4;i++)
						print_Line(i,bufshow[i]);
				}
				
				rx_flag = 0;
			}
			CLK_SysTickDelay(5000);
		}
}

void show_7seg(int i,int score)
{
	static int leading = 1;
	int data[4];
	data[3] = score/1000;
	score%=1000;
	data[2] = score/100;
	score%=100;
	data[1] = score/10;
	score%=10;
	data[0] = score;
	
	if(i==3)
		leading = 1;
	
	if(data[i]==0 && (i!=0 && leading))
		return;
	else
		leading = 0;
	
	CloseSevenSegment();
	ShowSevenSegment(i,data[i]);
}
