#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include "NUC100Series.h"
#include "SYS_init.h"
#include "LCD.h"

// ========= 貪食蛇參數 =========
#define MAP_W 64
#define MAP_H 32
#define CELL  2         // 1 格 = 2×2 pixels

// ========= Joystick ADC =========
volatile uint16_t joyX, joyY;
volatile uint8_t adc_flag = 0;

// ========= Snake =========
typedef struct {
    int x, y;
} Cell;

Cell snake[MAP_W * MAP_H];   // 最多 2048 節
int snake_len = 16;          // 初始長度 16
int dirx = 1, diry = 0;      // 初始方向：向右

int game_over = 0;

// ========= Timer Flag (200ms) =========
volatile uint8_t move_flag = 0;

//------------------------------------------------
//  ADC Interrupt
//------------------------------------------------
void ADC_IRQHandler(void)
{
    joyX = ADC_GET_CONVERSION_DATA(ADC, 0);
    joyY = ADC_GET_CONVERSION_DATA(ADC, 1);
    adc_flag = 1;

    ADC_CLR_INT_FLAG(ADC, ADC_ADF_INT);
}

void Init_ADC(void)
{
    ADC_Open(ADC, ADC_INPUT_MODE, ADC_OPERATION_MODE, (1<<0)|(1<<1));
    ADC_POWER_ON(ADC);
    ADC_EnableInt(ADC, ADC_ADF_INT);
    NVIC_EnableIRQ(ADC_IRQn);
    ADC_START_CONV(ADC);
}

//------------------------------------------------
//  Timer Interrupt (每 200ms 移動一次)
//------------------------------------------------
void TMR0_IRQHandler(void)
{
    TIMER_ClearIntFlag(TIMER0);
    move_flag = 1;
}

void Init_Timer(void)
{
    TIMER_Open(TIMER0, TIMER_PERIODIC_MODE, 5);  // 200ms
    TIMER_EnableInt(TIMER0);
    NVIC_EnableIRQ(TMR0_IRQn);
    TIMER_Start(TIMER0);
}

//------------------------------------------------
//  在 LCD 畫 2×2 pixel（你要替換成自己的 version）
//------------------------------------------------
void draw_cell(int gx, int gy, uint16_t color)
{
    int x = gx * CELL;
    int y = gy * CELL;
    fill_Rectangle(x, y, x + CELL - 1, y + CELL - 1, color, color);
}

//------------------------------------------------
//  Joystick 方向更新（Lab9-1）
//  不推 / 推太小力 → 不動
//------------------------------------------------
void update_direction()
{
    if(!adc_flag) return;  
    adc_flag = 0;

    int dx = joyX - 2048;   // 搖桿左右偏移
    int dy = joyY - 2048;   // 搖桿上下偏移

    int TH = 300;  // Dead Zone threshold

    // 不推 or 推太小力
    if(abs(dx) < TH && abs(dy) < TH)
        return;

    // 左右方向優先
    if(abs(dx) > abs(dy)) {
        if(dx > 0 && dirx != -1) { dirx = 1;  diry = 0; }   // 右
        else if(dx < 0 && dirx != 1) { dirx = -1; diry = 0; } // 左
    }
    else {
        if(dy > 0 && diry != -1) { dirx = 0; diry = 1; }    // 下
        else if(dy < 0 && diry != 1) { dirx = 0; diry = -1; } // 上
    }
}

//------------------------------------------------
//  Snake Move（Lab9-1 無水果）
//------------------------------------------------
void move_snake()
{
    if(game_over) return;

    // 新蛇頭位置
    int nx = snake[0].x + dirx;
    int ny = snake[0].y + diry;

    // 撞牆：停止
    if(nx < 0 || nx >= MAP_W || ny < 0 || ny >= MAP_H) {
        game_over = 1;
        return;
    }

    // 撞自己：停止
    for(int i=0; i<snake_len; i++){
        if(snake[i].x == nx && snake[i].y == ny){
            game_over = 1;
            return;
        }
    }

    // 畫新的蛇頭
    draw_cell(nx, ny, GREEN);

    // 記住尾巴位置（等等要擦掉）
    int tail_x = snake[snake_len - 1].x;
    int tail_y = snake[snake_len - 1].y;

    // 整個身體往前移
    for(int i = snake_len - 1; i > 0; i--)
        snake[i] = snake[i - 1];

    // 更新頭部
    snake[0].x = nx;
    snake[0].y = ny;

    // 擦掉尾巴（不清全螢幕）
    draw_cell(tail_x, tail_y, BLACK);
}

//------------------------------------------------
//  主程式：Lab9-1
//------------------------------------------------
int main(void)
{
    SYS_Init();
    init_LCD();
    clear_LCD();

    Init_ADC();
    Init_Timer();

    // 初始化蛇（16 Length, 中間水平, 向右）
    int midY = MAP_H / 2;
    int startX = 20;

    for(int i=0; i<snake_len; i++)
    {
        snake[i].x = startX - i;
        snake[i].y = midY;
        draw_cell(snake[i].x, snake[i].y, GREEN);
    }

    // Game Loop
    while(1)
    {
        update_direction();

        if(move_flag) {
            move_flag = 0;
            move_snake();
        }
    }
}
