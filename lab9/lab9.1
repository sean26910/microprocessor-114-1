#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include "NUC100Series.h"
#include "SYS_init.h"
#include "LCD.h"
#include "Seven_Segment.h"

#define MAP_W 64
#define MAP_H 32
#define CELL  2         // 每格 2×2 pixel
#define SPEED_TICK 200  // 每 200ms 移動一次

volatile uint16_t joyX, joyY;
volatile uint8_t adc_flag = 0;

typedef struct {
    int x, y;
} Cell;

Cell snake[MAP_W * MAP_H];
int snake_len = 16;        // 初始長度
int dirx = 1, diry = 0;    // 開始向右

Cell fruit;
int score = 0;
int game_over = 0;

//======================= Joystick ADC =======================
void ADC_IRQHandler(void)
{
    joyX = ADC_GET_CONVERSION_DATA(ADC, 0);
    joyY = ADC_GET_CONVERSION_DATA(ADC, 1);

    adc_flag = 1;
    ADC_CLR_INT_FLAG(ADC, ADC_ADF_INT);
}

void Init_ADC(void)
{
    ADC_Open(ADC, ADC_INPUT_MODE, ADC_OPERATION_MODE, (1<<0)|(1<<1));
    ADC_POWER_ON(ADC);
    ADC_EnableInt(ADC, ADC_ADF_INT);
    NVIC_EnableIRQ(ADC_IRQn);
    ADC_START_CONV(ADC);
}

//======================= Timer =======================
volatile uint8_t move_flag = 0;

void TMR0_IRQHandler(void)
{
    TIMER_ClearIntFlag(TIMER0);
    move_flag = 1;   // 每 200ms 觸發移動
}

void Init_Timer(void)
{
    TIMER_Open(TIMER0, TIMER_PERIODIC_MODE, 5); // 200ms
    TIMER_EnableInt(TIMER0);
    NVIC_EnableIRQ(TMR0_IRQn);
    TIMER_Start(TIMER0);
}

//======================= LCD Draw =======================
// 你要把 fill_Rectangle 改成你自己的畫 2×2 px 函式
void draw_cell(int gx, int gy, int color)
{
    int x = gx * CELL;
    int y = gy * CELL;
    fill_Rectangle(x, y, x + CELL - 1, y + CELL - 1, color, color);
}

//======================= Fruit =======================
int is_snake(int x, int y)
{
    for(int i=0; i<snake_len; i++)
        if(snake[i].x == x && snake[i].y == y)
            return 1;
    return 0;
}

void spawn_fruit()
{
    while(1) {
        fruit.x = rand() % MAP_W;
        fruit.y = rand() % MAP_H;
        if(!is_snake(fruit.x, fruit.y)) break;
    }
    draw_cell(fruit.x, fruit.y, YELLOW);
}

//======================= Joystick Direction =======================
void update_direction()
{
    if(!adc_flag) return;
    adc_flag = 0;

    int16_t dx = joyX - 2048;
    int16_t dy = joyY - 2048;

    int TH = 300;   // dead zone threshold → 你可以調整

    // 不推或推太小力
    if(abs(dx) < TH && abs(dy) < TH)
        return;

    // 判斷方向
    if(abs(dx) > abs(dy)) {
        if(dx > 0 && dirx != -1) { dirx = 1;  diry = 0; }
        else if(dx < 0 && dirx != 1) { dirx = -1; diry = 0; }
    } else {
        if(dy > 0 && diry != -1) { dirx = 0; diry = 1;  }
        else if(dy < 0 && diry != 1) { dirx = 0; diry = -1; }
    }
}

//======================= Move Snake =======================
void move_snake()
{
    if(game_over) return;

    // 新蛇頭位置
    int nx = snake[0].x + dirx;
    int ny = snake[0].y + diry;

    // 邊界
    if(nx < 0 || nx >= MAP_W || ny < 0 || ny >= MAP_H) {
        game_over = 1;
        return;
    }

    // 撞自己
    for(int i=0; i<snake_len; i++){
        if(snake[i].x == nx && snake[i].y == ny){
            game_over = 1;
            return;
        }
    }

    // 是否吃到水果
    int grow = (nx == fruit.x && ny == fruit.y);

    // 畫新頭
    draw_cell(nx, ny, GREEN);

    // 尾巴座標（準備 erase）
    int tail_x = snake[snake_len - 1].x;
    int tail_y = snake[snake_len - 1].y;

    // 身體移動
    for(int i = snake_len - 1; i > 0; i--)
        snake[i] = snake[i - 1];

    snake[0].x = nx;
    snake[0].y = ny;

    if(grow) {
        snake_len++;
        score++;
        Show_7seg(score);   // 你自己的 7seg 顯示函式
        spawn_fruit();
    } else {
        draw_cell(tail_x, tail_y, BLACK); // 擦尾
    }
}

//======================= Main =======================
int main(void)
{
    SYS_Init();
    init_LCD();
    clear_LCD();

    Init_ADC();
    Init_Timer();

    // 初始化蛇
    int startY = MAP_H / 2;
    for(int i=0; i<snake_len; i++){
        snake[i].x = 20 - i;
        snake[i].y = startY;
        draw_cell(snake[i].x, snake[i].y, GREEN);
    }

    spawn_fruit();
    Show_7seg(score);

    while(1) {
        update_direction();

        if(move_flag) {
            move_flag = 0;
            move_snake();
        }
    }
}
