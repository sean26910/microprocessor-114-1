//
// LCD_keypad : 3x3 keypad input and display on LCD
//
// EVB : Nu-LB-NUC140
// MCU : NUC140VE3CN  (LQPF-100)
#include <stdio.h>
#include <stdlib.h>
#include "NUC100Series.h"
#include "MCU_init.h"
#include "SYS_init.h"
#include "LCD.h"
#include "Scankey.h"
#include "Seven_Segment.h"

void Buzz(int number)
{
	int i;
	for (i=0; i<number; i++) {
      PB11=0; // PB11 = 0 to turn on Buzzer
	  CLK_SysTickDelay(100000);	 // Delay 
	  PB11=1; // PB11 = 1 to turn off Buzzer	
	  CLK_SysTickDelay(100000);	 // Delay 
	}
}

void Init_GPIO(void)
{
	GPIO_SetMode(PA, BIT12, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT13, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT14, GPIO_MODE_OUTPUT);
	PA12=1;
	PA13=1;
	PA14=1;
}

void Display_7seg(char* input,char label)
{//16
	int minus,mul,ans,i,size,n;
  if(label=='s')
	{
		size = 0,mul = 1,ans = 0;
		if(input[2]=='1')
		{
			minus = 1<<7;
			for(i=9;i>=3;i--)
			{
				if(input[i]=='1')
					ans+=mul;
				mul*=2;
			}
			ans = -(minus+ans);
			n = ans;
			while(n)
			{
				n/=10;
				size++;
			}
			for(i=size-1;i>=0;i--)
			{
				CloseSevenSegment();
				ShowSevenSegment(i,ans%10);
				ans/=10;
				CLK_SysTickDelay(2000);
			}
			CloseSevenSegment();
			ShowSevenSegment(size,16);
			CLK_SysTickDelay(2000);
		}
		else
		{
			
		}
	}
	else if(label=='u')
	{
		
	}
}


void mode(int key,int target)
{
	static char stor[10]="0b00000000",label='0';
	static int ans = 0;
	char st[100] = {0},chartemp;
	int index = 2,n,i,mul=1;
	n = target;
	
	if(key==2)
	{
		while(n)
		{
			stor[index++] = (n%2)+'0';
			n/=2;
		}
		while(index<10)
		{
			stor[index++] = '0';
		}
		
		for(i=0;i<4;i++)
		{
			chartemp = stor[2 + i];
			stor[2 + i] = stor[9 - i];
			stor[9 - i] = chartemp;
		}
		
	}
	else if(key==1)
	{
		for(i=9;i>=3;i--)
		{
			stor[i] = stor[i-1];
		}
		stor[2] = '1';
	}
	else if(key==4)
	{
		for(i=9;i>=3;i--)
		{
			stor[i] = stor[i-1];
		}
		stor[2] = '0';
	}
	else if(key==3)
	{
		for(i=2;i<9;i++)
		{
			stor[i] = stor[i+1];
		}
		stor[9] = '1';
	}
	else if(key==6)
	{
		for(i=2;i<9;i++)
		{
			stor[i] = stor[i+1];
		}
		stor[9] = '0';
	}
	else if(key==5)
	{
		for(i=2;i<10;i++)
			stor[i] = '0';
	}
	else if(key==7)
	{
		label = 's';
	}
	Display_7seg(stor,label);
	print_Line(0,stor);
	CLK_SysTickDelay(3000);
}

int key_release(void)
{
		static int prekey = 0;
		int presentkey = 0,result = 0;
		presentkey = ScanKey();
		CLK_SysTickDelay(1000);
		if(prekey!=0 && presentkey==0)
			result = prekey;
		else
			result = 0;
		prekey = presentkey;
		return result;
}

int main(void)
{
	int count = 0,line = 0,key,lastpressed,value=0;
	uint8_t keyin;
	Init_GPIO();
	SYS_Init();
	GPIO_SetMode(PB, BIT11, GPIO_MODE_OUTPUT);
	OpenSevenSegment();
	CloseSevenSegment();
	init_LCD();
	clear_LCD();
	
	OpenKeyPad();	              // initialize 3x3 keypad
	
	 
	while(1)
	{
	  key	= key_release();
		if(key!=0)
		{
			lastpressed = key;
			srand(count++);
			if(key==2)
				value = rand()%256;
		}
		
		mode(key,value);
		CLK_SysTickDelay(2000);
	}
}
