//
// GPIO_7seg : counting from 0 to 9999 and display on 7-segment LEDs
//
#include <stdio.h>
#include <stdlib.h>
#include "NUC100Series.h"
#include "MCU_init.h"
#include "SYS_init.h"
#include "LCD.h"
#include "Scankey.h"
#include "Seven_Segment.h"
//display an integer on four 7-segment LEDs
enum State{GREEN,YELLOW,RED};
enum gostop{INIT,CAR_GREEN,CAR_YELLOW,CAR_RED,CAR_10RED,CAR_ENDED};

struct TrafficSignal
{
	enum State state;
	enum gostop gostate;
	int timer;
};

void Init_GPIO(void)
{
	GPIO_SetMode(PA, BIT12, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT13, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PA, BIT14, GPIO_MODE_OUTPUT);
	PA12=1;
	PA13=1;
	PA14=1;
	
	GPIO_SetMode(PC, BIT12, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT13, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT14, GPIO_MODE_OUTPUT);
	GPIO_SetMode(PC, BIT15, GPIO_MODE_OUTPUT);
	PC12=1;PC13=1;PC14=1;PC15=1;
}

void TrafficSignal_initialize(struct TrafficSignal* ts)
{
	ts->state = YELLOW;
	ts->gostate = INIT;
	ts->timer = 5;
}

void TrafficSignal_countDown(struct TrafficSignal* ts)
{
	ts->timer -= 1;
	if(ts->timer<=0)
	{
		switch(ts->gostate)
		{
			case INIT:
				ts->state = GREEN;
				ts->gostate = CAR_GREEN;
				ts->timer = 5;
				break;
			case CAR_GREEN:
				ts->state = RED;
				ts->gostate = CAR_YELLOW;
				ts->timer = 3;
				break;
			case CAR_YELLOW:
				ts->state = RED;
				ts->gostate = CAR_RED;
				ts->timer = 3;
				break;
			case CAR_RED:
				ts->state = RED;
				ts->gostate = CAR_10RED;
				ts->timer = 10;
				break;
			case CAR_10RED:
				ts->state = RED;
				ts->gostate = CAR_ENDED;
				ts->timer = 3;
				break;
			case CAR_ENDED:
				ts->state = YELLOW;
				ts->gostate = INIT;
				ts->timer = 5;
		}
	}
}
void TrafficSignal_showLED(struct TrafficSignal* ts)
{
	if(ts->state == GREEN)
	{
		PA12 = 1;
		PA13 = 0;
		PA14 = 1;
	}
	else if(ts->state == YELLOW)
	{
		PA12 = 1;//blue
		PA13 = 0;//green
		PA14 = 0;//red
	}
	else if(ts->state == RED)
	{
		PA12 = 1;
		PA13 = 1;
		PA14 = 0;
	}
}


void Display_7seg(uint16_t value)
{
  int digit[4] = {0};
	int i,leading = 1,temp = value;
	digit[3] = value/1000;
	value = value%1000;
	digit[2] = value/100;
	value = value%100;
	digit[1] = value/10;
	value = value%10;
	digit[0] = value;

	for(i=3;i>=0;i--)
	{
		CLK_SysTickDelay(2000);
		if(i!=0 && (leading && digit[i]==0))
			continue;
		else
			leading = 0;
		
		CloseSevenSegment();
		ShowSevenSegment(i,digit[i]);
	}
	if(temp==0)
	{
		CloseSevenSegment();
		ShowSevenSegment(0,0);
		CLK_SysTickDelay(2000);
	}
}

int get_key(void)
{
		static int prekey = 0;
		int presentkey = 0,result = 0;
		presentkey = ScanKey();
		CLK_SysTickDelay(1000);
		if(prekey!=0 && presentkey==0)
			result = prekey;
		else
			result = 0;
		prekey = presentkey;
		return result;
}
//enum gostop{INIT,CAR_GREEN,CAR_YELLOW,CAR_RED,CAR_10RED,CAR_ENDED};
void state_machine(struct TrafficSignal* ts,int step)
{
	switch(ts->gostate)
	{
		case INIT:
			Display_7seg(0);
			if(step==0)
			{
				PA12=0;
				PA13=0;
				PA14=0;
			}
			else
				TrafficSignal_showLED(ts);
			break;
		case CAR_GREEN:
			Display_7seg(ts->timer);
			TrafficSignal_showLED(ts);
			break;
		case CAR_YELLOW:
			Display_7seg(ts->timer);
			TrafficSignal_showLED(ts);
			break;
		case CAR_RED:
			Display_7seg(ts->timer);
			TrafficSignal_showLED(ts);
			break;
		case CAR_10RED:
			Display_7seg(ts->timer);
			TrafficSignal_showLED(ts);
			break;
		case CAR_ENDED:
			Display_7seg(ts->timer);
			TrafficSignal_showLED(ts);
			break;
	}
}

int main(void)
{
	struct TrafficSignal ts;
	int step = 0,key;

	Init_GPIO();
	SYS_Init();
	GPIO_SetMode(PB, BIT11, GPIO_MODE_OUTPUT);
	OpenSevenSegment();
	CloseSevenSegment();
	init_LCD();
	clear_LCD();
	OpenKeyPad();

	TrafficSignal_initialize(&ts);
	while(1)
	{
		if(ts.gostate == INIT)
		{
			key = get_key();
			if(key==5)
			{
				ts.gostate = CAR_GREEN;
				ts.state = YELLOW;
				step=0;
			}
		}
		draw_Bmp32x32(60,0,1,0,bmp_logo_go);
		step = (step+1)%100;
		state_machine(&ts,step);//«G¨®½ø
		if(ts.gostate!=INIT && step==0)
			TrafficSignal_countDown(&ts);
		CLK_SysTickDelay(2000);
	}
}
